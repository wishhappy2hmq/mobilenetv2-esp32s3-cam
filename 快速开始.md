# ESP32-S3 MobileNetV2 实时分类系统 - 快速使用指南

## ✨ 特点

所有代码都整合在 **一个文件** 中：`main/app_main.cpp` (约650行)

功能完整：
- ✅ WiFi连接
- ✅ 摄像头实时采集
- ✅ HTTP视频流服务器
- ✅ 每10帧进行一次图像分类
- ✅ Web界面显示结果

---

## 🚀 三步开始

### 1. 修改配置

打开 `main/app_main.cpp`，修改第37-38行：

```cpp
#define WIFI_SSID      "你的WiFi名称"
#define WIFI_PASSWORD  "你的WiFi密码"
```

### 2. 修改类别标签

打开 `esp-dl/vision/classification/binary_cls_category_name.hpp`：

```cpp
static const char *binary_cls_cat_names[] = {
    "正常",  // 你的类别1
    "异常"   // 你的类别2
};
```

### 3. 编译烧录

```bash
cd my_mobilenetv2_esp/mobilenetv2_cls
idf.py fullclean
idf.py set-target esp32s3
idf.py build
idf.py flash monitor
```

---

## 📱 使用方法

1. **烧录后查看串口输出**，找到ESP32的IP地址：
   ```
   Got IP address: 192.168.x.x
   ```

2. **在浏览器中访问**：
   ```
   http://192.168.x.x
   ```

3. **你会看到**：
   - 📹 实时视频流
   - 📊 每10帧更新的分类结果
   - 🎯 置信度百分比

---

## ⚙️ 配置说明

所有配置都在 `main/app_main.cpp` 文件顶部：

### WiFi配置 (第37-38行)
```cpp
#define WIFI_SSID      "YOUR_WIFI_SSID"
#define WIFI_PASSWORD  "YOUR_WIFI_PASSWORD"
```

### 推理间隔 (第41行)
```cpp
#define INFERENCE_INTERVAL 10  // 每10帧推理一次
```

可以改为：
- `5` = 更频繁推理
- `20` = 较少推理，性能更好

### 摄像头引脚 (第44-59行)
已配置为你的硬件引脚，通常不需要修改。

---

## 📂 项目文件结构

```
mobilenetv2_cls/
├── main/
│   ├── app_main.cpp          # ⭐ 所有代码都在这里！
│   ├── CMakeLists.txt
│   └── idf_component.yml
│
├── imagenet_cls/             # 模型组件
│   ├── imagenet_cls.cpp/hpp
│   └── models/s3/
│       └── image_classifier_320x320_int8.espdl
│
├── esp-dl/                   # ESP-DL库
│   └── vision/classification/
│       ├── binary_cls_postprocessor.cpp/hpp
│       └── binary_cls_category_name.hpp  # ⚠️ 修改类别标签
│
└── CMakeLists.txt
```

---

## 🎯 代码结构说明

`app_main.cpp` 包含以下模块：

```cpp
// 第33-41行: 配置参数
#define WIFI_SSID ...
#define INFERENCE_INTERVAL ...

// 第62-152行: WiFi管理
static esp_err_t wifi_init(void) { ... }

// 第154-226行: 摄像头管理
static esp_err_t camera_init(void) { ... }

// 第228-469行: HTTP服务器
static esp_err_t httpd_start(void) { ... }

// 第471-579行: 推理任务
static void inference_task(void *pvParameters) { ... }

// 第581-647行: 主函数
extern "C" void app_main(void) { ... }
```

---

## 📊 性能指标

| 操作 | 时间 |
|------|------|
| JPEG解码 | ~15-20ms |
| 模型推理 (320x320) | ~2000-3000ms |
| 后处理 | ~1ms |
| 视频流帧率 | ~30 FPS |
| 推理频率 | 每秒1次 |

---

## 🐛 常见问题

### WiFi无法连接
- 检查SSID和密码
- 确保是2.4GHz WiFi
- 查看串口日志

### 摄像头初始化失败
- 检查引脚连接
- 确认摄像头电源稳定
- 查看串口错误信息

### Web页面打不开
- 确认ESP32已连接WiFi
- 电脑和ESP32在同一网络
- 使用正确的IP地址

### 推理结果不正确
1. 检查类别标签顺序
2. 确认预处理参数
3. 查看串口输出的详细结果

---

## 🔧 修改建议

### 修改推理频率
```cpp
// 第41行
#define INFERENCE_INTERVAL 5  // 改为每5帧
```

### 修改视频质量
```cpp
// 第185行 camera_init() 函数中
.jpeg_quality = 8,  // 改为更高质量 (0-63)
```

### 添加更多日志
```cpp
// 在 inference_task() 中添加
ESP_LOGI(TAG, "Image size: %dx%d", img.width, img.height);
```

---

## 📚 使用的模型

**当前模型**: `image_classifier_320x320_int8.espdl`
- 输入尺寸: 320×320×3
- 输出类别: 2类（二分类）
- 量化方式: INT8

模型位置: `imagenet_cls/models/s3/`

---

## 💡 技巧

1. **串口监控快捷键**:
   - `Ctrl+]` 退出monitor
   - `Ctrl+T` → `Ctrl+R` 重启ESP32

2. **快速查看IP**:
   ```bash
   idf.py monitor | grep "Got IP"
   ```

3. **分步编译**:
   ```bash
   idf.py build        # 只编译
   idf.py flash        # 只烧录
   idf.py monitor      # 只监控
   ```

---

## ✅ 检查清单

在编译前确认：

- [ ] 修改了WiFi SSID和密码
- [ ] 修改了类别标签（binary_cls_category_name.hpp）
- [ ] ESP32-S3已连接到电脑
- [ ] 摄像头已正确连接
- [ ] ESP-IDF环境已配置

---

## 🎉 完成后

访问 `http://<ESP32_IP>` 即可看到：
- 实时摄像头画面
- 每10帧更新的分类结果
- 置信度百分比

享受你的实时分类系统！🚀
